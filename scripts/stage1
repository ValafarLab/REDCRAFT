#!/usr/bin/perl 

$numarg = $#ARGV;
if($numarg < 0) {
	print "Usage: $0 <Prefix> [non-gly space 1|2|all] [gly space 0|non-gly 1|all] [cutoff Hz]\n";
	exit(1);
}
$RDC_prefix = $ARGV[0];


sub getAllSpace {
	my $grid = 10;
	my @ret;
	for (my $phi = -180; $phi < 180; $phi += $grid) {
		for (my $psi = -180; $psi < 180; $psi += $grid) {
			push(@ret, "$phi $psi");
		}
	}
	return @ret;
}
@R1 = (
	"-170 150", "-170 160", "-170 170", "-160 120", "-160 130", "-160 140",
	"-160 150", "-160 160", "-160 170", "-150 110", "-150 120", "-150 130",
	"-150 140", "-150 150", "-150 160", "-150 170", "-140 100", "-140 110",
	"-140 120", "-140 130", "-140 140", "-140 150", "-140 160", "-140 170",
	"-130 -10", "-130 0", "-130 90", "-130 100", "-130 110", "-130 120",
	"-130 130", "-130 140", "-130 150", "-130 160", "-130 170", "-120 -30",
	"-120 -20", "-120 -10", "-120 0", "-120 10", "-120 20", "-120 90",
	"-120 100", "-120 110", "-120 120", "-120 130", "-120 140", "-120 150",
	"-120 160", "-120 170", "-110 -40", "-110 -30", "-110 -20", "-110 -10",
	"-110 0", "-110 10", "-110 20", "-110 30", "-110 100", "-110 110",
	"-110 120", "-110 130", "-110 140", "-110 150", "-110 160", "-110 170",
	"-100 -50", "-100 -40", "-100 -30", "-100 -20", "-100 -10", "-100 0",
	"-100 10", "-100 20", "-100 30", "-100 90", "-100 100", "-100 110",
	"-100 120", "-100 130", "-100 140", "-100 150", "-100 160", "-100 170",
	"-90 -60", "-90 -50", "-90 -40", "-90 -30", "-90 -20", "-90 -10",
	"-90 0", "-90 10", "-90 20", "-90 90", "-90 100", "-90 110", "-90 120",
	"-90 130", "-90 140", "-90 150", "-90 160", "-90 170", "-80 -60",
	"-80 -50", "-80 -40", "-80 -30", "-80 -20", "-80 -10", "-80 0", "-80 10",
	"-80 20", "-80 100", "-80 110", "-80 120", "-80 130", "-80 140",
	"-80 150", "-80 160", "-80 170", "-70 -70", "-70 -60", "-70 -50",
	"-70 -40", "-70 -30", "-70 -20", "-70 -10", "-70 0", "-70 10", "-70 100",
	"-70 110", "-70 120", "-70 130", "-70 140", "-70 150", "-70 160",
	"-70 170", "-60 -70", "-60 -60", "-60 -50", "-60 -40", "-60 -30",
	"-60 -20", "-60 -10", "-60 0", "-60 110", "-60 120", "-60 130", "-60 140",
	"-60 150", "-60 160", "-60 170", "-50 -70", "-50 -60", "-50 -50",
	"-50 -40", "-50 -30", "-50 -20", "-50 -10", "-50 120", "-50 130",
	"-50 140", "-50 150", "-40 -70", "-40 -60", "-40 -50", "-40 -40",
	"-40 -30", "-40 -20", "-40 130", "-40 140", "-30 -70", "-30 -60",
	"-30 -50", "-30 -40", "50 30", "50 40", "50 50", "60 30", "60 40",
	"60 50", "70 30", "70 40");
@R2 = (
	"-180 -180", "-180 -170", "-180 -70", "-180 -60", "-180 70", "-180 80",
	 "-180 90", "-180 100", "-180 110", "-180 120", "-180 130",
	 "-180 140", "-180 150", "-180 160", "-180 170", "-170 -180", "-170 -170",
	 "-170 -160", "-170 -150", "-170 -140", "-170 -70", "-170 -60", "-170 -50",
	 "-170 -20", "-170 -10", "-170 0", "-170 10", "-170 20", "-170 30", "-170 40",
	 "-170 60", "-170 70", "-170 80", "-170 90", "-170 100", "-170 110", "-170 120",
	 "-170 130", "-170 140", "-170 150", "-170 160", "-170 170", "-160 -180",
	 "-160 -170", "-160 -160", "-160 -150", "-160 -140", "-160 -70", "-160 -60",
	 "-160 -50", "-160 -40", "-160 -30", "-160 -20", "-160 -10", "-160 0", "-160 10",
	 "-160 20", "-160 30", "-160 40", "-160 50", "-160 60", "-160 70", "-160 80",
	 "-160 90", "-160 100", "-160 110", "-160 120", "-160 130", "-160 140",
	 "-160 150", "-160 160", "-160 170", "-150 -180", "-150 -170", "-150 -160",
	 "-150 -150", "-150 -140", "-150 -80", "-150 -70", "-150 -60", "-150 -50",
	 "-150 -40", "-150 -30", "-150 -20", "-150 -10", "-150 0", "-150 10", "-150 20",
	 "-150 30", "-150 40", "-150 50", "-150 60", "-150 70", "-150 80", "-150 90",
	 "-150 100", "-150 110", "-150 120", "-150 130", "-150 140", "-150 150", "-150 160",
	 "-150 170", "-140 -180", "-140 -170", "-140 -160", "-140 -150", "-140 -140", "-140 -80",
	 "-140 -70", "-140 -60", "-140 -50", "-140 -40", "-140 -30", "-140 -20", "-140 -10",
	 "-140 0", "-140 10", "-140 20", "-140 30", "-140 40", "-140 50", "-140 60", "-140 70",
	 "-140 80", "-140 90", "-140 100", "-140 110", "-140 120", "-140 130", "-140 140",
	 "-140 150", "-140 160", "-140 170", "-130 -180", "-130 -170", "-130 -160", "-130 -150",
	 "-130 -140", "-130 -130", "-130 -120", "-130 -100", "-130 -90", "-130 -80", "-130 -70",
	 "-130 -60", "-130 -50", "-130 -40", "-130 -30", "-130 -20", "-130 -10", "-130 0",
	 "-130 10", "-130 20", "-130 30", "-130 40", "-130 50", "-130 60", "-130 70",
	 "-130 80", "-130 90", "-130 100", "-130 110", "-130 120", "-130 130", "-130 140",
	 "-130 150", "-130 160", "-130 170", "-120 -180", "-120 -170", "-120 -160", "-120 -150",
	 "-120 -140", "-120 -130", "-120 -120", "-120 -100", "-120 -90", "-120 -80",
	 "-120 -70", "-120 -60", "-120 -50", "-120 -40", "-120 -30", "-120 -20",
	 "-120 -10", "-120 0", "-120 10", "-120 20", "-120 30", "-120 40", "-120 50", "-120 60",
	 "-120 70", "-120 80", "-120 90", "-120 100", "-120 110", "-120 120", "-120 130",
	 "-120 140", "-120 150", "-120 160", "-120 170", "-110 -180", "-110 -170", "-110 -160",
	 "-110 -150", "-110 -140", "-110 -130", "-110 -120", "-110 -110", "-110 -100", "-110 -90",
	 "-110 -80", "-110 -70", "-110 -60", "-110 -50", "-110 -40", "-110 -30", "-110 -20",
	 "-110 -10", "-110 0", "-110 10", "-110 20", "-110 30", "-110 40", "-110 50",
	 "-110 60", "-110 70", "-110 80", "-110 90", "-110 100", "-110 110", "-110 120",
	 "-110 130", "-110 140", "-110 150", "-110 160", "-110 170", "-100 -180", "-100 -170",
	 "-100 -160", "-100 -150", "-100 -140", "-100 -130", "-100 -120", "-100 -110", "-100 -100",
	 "-100 -90", "-100 -80", "-100 -70", "-100 -60", "-100 -50", "-100 -40", "-100 -30",
	 "-100 -20", "-100 -10", "-100 0", "-100 10", "-100 20", "-100 30", "-100 40",
	 "-100 50", "-100 60", "-100 70", "-100 80", "-100 90", "-100 100", "-100 110",
	 "-100 120", "-100 130", "-100 140", "-100 150", "-100 160", "-100 170", "-90 -180",
	 "-90 -170", "-90 -160", "-90 -150", "-90 -140", "-90 -130", "-90 -120", "-90 -110",
	 "-90 -100", "-90 -90", "-90 -80", "-90 -70", "-90 -60", "-90 -50", "-90 -40",
	 "-90 -30", "-90 -20", "-90 -10", "-90 0", "-90 10", "-90 20", "-90 30",
	 "-90 40", "-90 50", "-90 60", "-90 70", "-90 80", "-90 90", "-90 100",
	 "-90 110", "-90 120", "-90 130", "-90 140", "-90 150", "-90 160", "-90 170",
	 "-80 -180", "-80 -170", "-80 -160", "-80 -150", "-80 -140", "-80 -130", "-80 -100",
	 "-80 -90", "-80 -80", "-80 -70", "-80 -60", "-80 -50", "-80 -40", "-80 -30",
	 "-80 -20", "-80 -10", "-80 0", "-80 10", "-80 20", "-80 30", "-80 40",
	 "-80 50", "-80 60", "-80 70", "-80 80", "-80 90", "-80 100", "-80 110",
	 "-80 120", "-80 130", "-80 140", "-80 150", "-80 160", "-80 170", "-70 -180",
	 "-70 -170", "-70 -160", "-70 -150", "-70 -110", "-70 -100", "-70 -90", "-70 -80",
	 "-70 -70", "-70 -60", "-70 -50", "-70 -40", "-70 -30", "-70 -20", "-70 -10",
	 "-70 0", "-70 10", "-70 20", "-70 30", "-70 40", "-70 50", "-70 60",
	 "-70 70", "-70 80", "-70 90", "-70 100", "-70 110", "-70 120", "-70 130",
	 "-70 140", "-70 150", "-70 160", "-70 170", "-60 -180", "-60 -170", "-60 -160",
	 "-60 -110", "-60 -100", "-60 -90", "-60 -80", "-60 -70", "-60 -60", "-60 -50",
	 "-60 -40", "-60 -30", "-60 -20", "-60 -10", "-60 0", "-60 10", "-60 20",
	 "-60 30", "-60 40", "-60 50", "-60 60", "-60 70", "-60 80", "-60 90",
	 "-60 100", "-60 110", "-60 120", "-60 130", "-60 140", "-60 150", "-60 160",
	 "-60 170", "-50 -180", "-50 -170", "-50 -160", "-50 -100", "-50 -90", "-50 -80",
	 "-50 -70", "-50 -60", "-50 -50", "-50 -40", "-50 -30", "-50 -20", "-50 -10",
	 "-50 0", "-50 10", "-50 20", "-50 30", "-50 50", "-50 60", "-50 70",
	 "-50 80", "-50 90", "-50 100", "-50 110", "-50 120", "-50 130", "-50 140",
	 "-50 150", "-50 160", "-50 170", "-40 -100", "-40 -90", "-40 -80", "-40 -70",
	 "-40 -60", "-40 -50", "-40 -40", "-40 -30", "-40 -20", "-40 -10", "-40 0",
	 "-40 10", "-40 80", "-40 90", "-40 100", "-40 110", "-40 120", "-40 130",
	 "-40 140", "-40 150", "-40 160", "-40 170", "-30 -100", "-30 -90", "-30 -80",
	 "-30 -70", "-30 -60", "-30 -50", "-30 -40", "-30 -30", "-30 -20", "-30 -10",
	 "-30 0", "-30 90", "-30 100", "-30 110", "-30 120", "-30 130", "-30 140",
	 "-30 150", "-30 160", "-30 170", "-20 -90", "-20 -80", "-20 -70", "-20 -60",
	 "-20 -50", "-20 -40", "-20 -30", "-20 -20", "-20 90", "-20 100", "-20 110",
	 "-20 120", "-20 130", "-20 140", "-20 150", "-10 -90", "-10 -80", "-10 -70",
	 "-10 -60", "-10 -50", "-10 -40", "-10 -30", "-10 90", "-10 100", "-10 110",
	 "-10 140", "-10 150", "0 -90", "0 -80", "0 -70", "0 -60", "0 -50",
	 "10 -80", "10 -70", "30 40", "30 50", "30 60", "30 70", "30 80",
	 "30 90", "40 20", "40 30", "40 40", "40 50", "40 60", "40 70",
	 "40 80", "40 90", "50 -170", "50 -160", "50 -150", "50 -140", "50 -10",
	 "50 0", "50 10", "50 20", "50 30", "50 40", "50 50", "50 60",
	 "50 70", "50 80", "50 90", "60 -170", "60 -160", "60 -150", "60 -140",
	 "60 -10", "60 0", "60 10", "60 20", "60 30", "60 40", "60 50",
	 "60 60", "60 70", "60 80", "60 90", "60 100", "70 -170", "70 -160",
	 "70 -10", "70 0", "70 10", "70 20", "70 30", "70 40", "70 50",
	 "70 60", "70 70", "70 80", "70 90", "70 100", "80 -10", "80 0",
	 "80 10", "80 20", "80 30", "80 40", "80 50", "80 60", "80 90",
	 "80 100", "90 -10", "90 0", "90 10", "90 20", "90 30", "90 50",
	 "90 60", "150 150", "150 160", "160 140", "160 150", "160 160", "160 170",
	 "170 -180", "170 -170", "170 90", "170 100", "170 110", "170 120", "170 130",
	 "170 140", "170 150", "170 160", "170 170");
@RG = (
	"-180 -180", "-180 -170", "-180 -160", "-180 -150", "-180 -140", "-180 -130", "-180 130", 
	"-180 140", "-180 150", "-180 160", "-180 170", "-170 -180", "-170 -170", "-170 -160", 
	"-170 -150", "-170 -140", "-170 130", "-170 140", "-170 150", "-170 160", "-170 170", 
	"-160 -180", "-160 -170", "-160 -160", "-160 -150", "-160 -140", "-160 130", "-160 140", 
	"-160 150", "-160 160", "-160 170", "-150 -180", "-150 -170", "-150 -160", "-150 -150", 
	"-150 -140", "-150 130", "-150 140", "-150 150", "-150 160", "-150 170", "-140 -180", 
	"-140 -170", "-140 -160", "-140 -150", "-140 -140", "-140 -130", "-140 0", "-140 10", 
	"-140 20", "-140 30", "-140 120", "-140 130", "-140 140", "-140 150", "-140 160", 
	"-140 170", "-130 -180", "-130 -170", "-130 -160", "-130 -150", "-130 -140", "-130 -130", 
	"-130 -120", "-130 -20", "-130 -10", "-130 0", "-130 10", "-130 20", "-130 30", 
	"-130 40", "-130 120", "-130 130", "-130 140", "-130 150", "-130 160", "-130 170", 
	"-120 -180", "-120 -170", "-120 -160", "-120 -150", "-120 -140", "-120 -130", "-120 -120", 
	"-120 -110", "-120 -30", "-120 -20", "-120 -10", "-120 0", "-120 10", "-120 20", 
	"-120 30", "-120 40", "-120 110", "-120 120", "-120 130", "-120 140", "-120 150", 
	"-120 160", "-120 170", "-110 -180", "-110 -170", "-110 -160", "-110 -150", "-110 -140", 
	"-110 -130", "-110 -120", "-110 -110", "-110 -100", "-110 -40", "-110 -30", "-110 -20", 
	"-110 -10", "-110 0", "-110 10", "-110 20", "-110 30", "-110 40", "-110 110", 
	"-110 120", "-110 130", "-110 140", "-110 150", "-110 160", "-110 170", "-100 -180", 
	"-100 -170", "-100 -160", "-100 -150", "-100 -140", "-100 -130", "-100 -120", "-100 -110", 
	"-100 -100", "-100 -90", "-100 -50", "-100 -40", "-100 -30", "-100 -20", "-100 -10", 
	"-100 0", "-100 10", "-100 20", "-100 30", "-100 40", "-100 50", "-100 110", 
	"-100 120", "-100 130", "-100 140", "-100 150", "-100 160", "-100 170", "-90 -180", 
	"-90 -170", "-90 -160", "-90 -150", "-90 -140", "-90 -130", "-90 -120", "-90 -110", 
	"-90 -100", "-90 -60", "-90 -50", "-90 -40", "-90 -30", "-90 -20", "-90 -10", 
	"-90 0", "-90 10", "-90 20", "-90 30", "-90 40", "-90 50", "-90 60", 
	"-90 100", "-90 110", "-90 120", "-90 130", "-90 140", "-90 150", "-90 160", 
	"-90 170", "-80 -180", "-80 -170", "-80 -160", "-80 -150", "-80 -140", "-80 -130", 
	"-80 -60", "-80 -50", "-80 -40", "-80 -30", "-80 -20", "-80 -10", "-80 0", 
	"-80 10", "-80 20", "-80 30", "-80 40", "-80 50", "-80 60", "-80 110", 
	"-80 120", "-80 130", "-80 140", "-80 150", "-80 160", "-80 170", "-70 -180", 
	"-70 -170", "-70 -160", "-70 -150", "-70 -70", "-70 -60", "-70 -50", "-70 -40", 
	"-70 -30", "-70 -20", "-70 -10", "-70 0", "-70 10", "-70 20", "-70 110", 
	"-70 120", "-70 130", "-70 140", "-70 150", "-70 160", "-70 170", "-60 -180", 
	"-60 -170", "-60 -70", "-60 -60", "-60 -50", "-60 -40", "-60 -30", "-60 -20", 
	"-60 -10", "-60 0", "-60 110", "-60 120", "-60 130", "-60 140", "-60 150", 
	"-60 160", "-60 170", "-50 -70", "-50 -60", "-50 -50", "-50 -40", "-50 -30", 
	"-50 -20", "-50 -10", "-50 110", "-50 120", "-50 130", "-50 140", "-50 150", 
	"-50 160", "-50 170", "-40 -60", "-40 -50", "-40 -40", "-40 -30", "-40 120", 
	"-40 130", "-40 140", "40 -140", "40 -130", "40 -120", "40 30", "40 40", 
	"40 50", "40 60", "50 -170", "50 -160", "50 -150", "50 -140", "50 -130", 
	"50 -120", "50 -110", "50 10", "50 20", "50 30", "50 40", "50 50", 
	"50 60", "50 70", "60 -180", "60 -170", "60 -160", "60 -150", "60 -140", 
	"60 -130", "60 -120", "60 -110", "60 0", "60 10", "60 20", "60 30", 
	"60 40", "60 50", "60 60", "60 70", "60 170", "70 -180", "70 -170", 
	"70 -160", "70 -150", "70 -140", "70 -130", "70 -120", "70 -110", "70 -20", 
	"70 -10", "70 0", "70 10", "70 20", "70 30", "70 40", "70 50", 
	"70 60", "70 70", "70 150", "70 160", "70 170", "80 -180", "80 -170", 
	"80 -160", "80 -150", "80 -140", "80 -130", "80 -120", "80 -110", "80 -60", 
	"80 -50", "80 -40", "80 -30", "80 -20", "80 -10", "80 0", "80 10", 
	"80 20", "80 30", "80 40", "80 50", "80 60", "80 130", "80 140", 
	"80 150", "80 160", "80 170", "90 -180", "90 -170", "90 -160", "90 -150", 
	"90 -140", "90 -130", "90 -120", "90 -110", "90 -100", "90 -60", "90 -50", 
	"90 -40", "90 -30", "90 -20", "90 -10", "90 0", "90 10", "90 20", 
	"90 30", "90 40", "90 50", "90 60", "90 100", "90 110", "90 120", 
	"90 130", "90 140", "90 150", "90 160", "90 170", "100 -180", "100 -170", 
	"100 -160", "100 -150", "100 -140", "100 -130", "100 -120", "100 -110", "100 -50", 
	"100 -40", "100 -30", "100 -20", "100 -10", "100 0", "100 10", "100 20", 
	"100 30", "100 40", "100 50", "100 90", "100 100", "100 110", "100 120", 
	"100 130", "100 140", "100 150", "100 160", "100 170", "110 -180", "110 -170", 
	"110 -160", "110 -150", "110 -140", "110 -130", "110 -120", "110 -110", "110 -40", 
	"110 -30", "110 -20", "110 -10", "110 0", "110 10", "110 20", "110 30", 
	"110 40", "110 100", "110 110", "110 120", "110 130", "110 140", "110 150", 
	"110 160", "110 170", "120 -180", "120 -170", "120 -160", "120 -150", "120 -140", 
	"120 -130", "120 -120", "120 -110", "120 -40", "120 -30", "120 -20", "120 -10", 
	"120 0", "120 10", "120 20", "120 30", "120 110", "120 120", "120 130", 
	"120 140", "120 150", "120 160", "120 170", "130 -180", "130 -170", "130 -160", 
	"130 -150", "130 -140", "130 -130", "130 -120", "130 -40", "130 -30", "130 -20", 
	"130 -10", "130 0", "130 10", "130 20", "130 120", "130 130", "130 140", 
	"130 150", "130 160", "130 170", "140 -180", "140 -170", "140 -160", "140 -150", 
	"140 -140", "140 -130", "140 -120", "140 -30", "140 -20", "140 -10", "140 0", 
	"140 130", "140 140", "140 150", "140 160", "140 170", "150 -180", "150 -170", 
	"150 -160", "150 -150", "150 -140", "150 -130", "150 140", "150 150", "150 160", 
	"150 170", "160 -180", "160 -170", "160 -160", "160 -150", "160 -140", "160 -130", 
	"160 140", "160 150", "160 160", "160 170", "170 -180", "170 -170", "170 -160", 
	"170 -150", "170 -140", "170 -130", "170 140", "170 150", "170 160", "170 170", 
);

print "Non-Gly: ";
if ($ARGV[1] eq "all") {
	@AlaList = getAllSpace();
	print "All space";
} elsif ($ARGV[1] eq 2) {
	@AlaList = @R2;
	print "Ramachandran Level 2 (less strict)";
} else {
	print "Ramachandran Level 1 (more strict)";
	@AlaList = @R1;
}
print "\nGly    : ";
if ($ARGV[2] eq "all") {
	@GlyList = getAllSpace();
	print "All space";
} elsif ($ARGV[2] eq 1) {
	print "Ramachandran Level 1 (more strict) for NON-GLY!";
	@GlyList = @R1;
} else {
	@GlyList = @RG;
	print "Ramachandran for GLY";
}
print "\nRDC File Prefix $RDC_prefix\n";
$m = 1;
$m++ while (-e $RDC_prefix.'.'.$m);
$Media = $m - 1;
if (!$Media) {
	print "No alignment media found! Not even 1!\n	Please check your specified prefix \"$RDC_prefix\".\n";
	exit(1);
}
print "Alignment Media found: $Media\n";
if ($ARGV[3]) {
	$cutoff = $ARGV[3];
	print "RDC Fitness cutoff: $cutoff\n";
} else { $cutoff = 0; }

sub FilterJ {
	($phi, $J, $error, $Gly) = @_;
	if($Gly == 1) {
		if( $J > 13.476) { $J = 13.476; }
		if( $J < 5.6) { $J = 5.6; }

		$angle = ($phi - 60) * 3.141592 / 180;
		$cal_J = 6.4 * cos($angle) * cos($angle) - 1.4 * cos($angle) + 1.9;
		$angle = ($phi + 60) * 3.141592 / 180;
		$cal_J = 6.4 * cos($angle) * cos($angle) - 1.4 * cos($angle) + 1.9 + $cal_J;
	} else {
		if( $J > 9.7) { $J = 9.7; }
		if( $J < 1.823) { $J = 1.823; }

		$angle = ($phi - 60) * 3.141592 / 180;
		$cal_J = 6.4 * cos($angle) * cos($angle) - 1.4 * cos($angle) + 1.9;
	}

	$diff = abs($cal_J - $J);
	if( $diff <= $error) {
		$return_value = 1;
	} else {
		$return_value = 0;
	}
	return $return_value;
}

open FILE, $RDC_prefix.'.1'; @_=<FILE>;
	$start = 1;
	$stop = $./7;
close FILE;

print "Residue count: $stop\n";

for($i = $start; $i <= $stop; $i++) {
	$linenumber = ($i-1)*7+1;
#Get line number $linenumber
	$line = `sed '$linenumber q;d' $RDC_prefix.1`;
	@listline = split(" ", $line);
	$aatype = $listline[0];
	$J = $listline[1];
	if($aatype =~ /GLY/) { @List = @GlyList; $Gly = 1}
	else { @List = @AlaList; $Gly = 0; }

	print "$i) $aatype ";
	if($J == 999) {
		print "(without J)";
	}

	#print "Ram file: $List ";

	open (outfile, ">test.out"), or die "Could not open file test.out\n"; 
	$rem = 0;
	$tot = 0;
	for my $line (@List) { #while(<listfile>) {
		$tot++;	
		#chomp($_);
		#$line = $_;
		@listline = split(" ", $line);
		$phi = $listline[0];
		$psi = $listline[1];

		$ValidPhi = 1;
		if($J != 999) {
			$ValidPhi = FilterJ($phi, $J, 2.5, $Gly);
		} 

		if($ValidPhi == 1) {
			$shift = $i - 1;
			if ($cutoff ne "skip") {
				$results=`molan -e -d$RDC_prefix -p. -m$Media -o$shift "$phi $psi" 2>/dev/null`;
			} else {
				$results = 0;
			}
			chomp($results);
			@listline = split(" ", $results);
			$rmsd = $listline[$#listline];
			if ($rmsd eq "nan") { $rmsd = 0; }
			if ($cutoff == 0 || $rmsd < $cutoff) {
				print outfile "$phi $psi $rmsd\n";
			} else {
				$rem++;
			}
		}
	}
	if ($tot == $rem) {
		print "Warning! All angles exceeded $cutoff Hz. 0 angles in this file!";
	}
	print "\n";
	close(listfile);
	close(outfile);

	`sort -g -k 3 test.out > $i.angles`;
	`rm test.out`;
}
